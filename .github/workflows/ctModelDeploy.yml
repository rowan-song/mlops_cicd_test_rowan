name: CT Model Deploy

on:
  issues:
    types: [closed]

jobs:
  add-comment:
    permissions:
      issues: write
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'ct')
    steps:
      - name: Get current timestamp
        id: timestamp
        run: |
          echo "timestamp=$(TZ=":Asia/Seoul" date -R|sed 's/.....$//')" >> $GITHUB_ENV
      - name: Add Comment
        run: |
          if [ "$STATE_REASON" == "completed" ] || [ "$SENDER" != "github-actions" ]; then
            gh issue comment "$NUMBER" --body "CT Model Deploy was approved at ${{env.timestamp}}."
          else
            gh issue comment "$NUMBER" --body "CT Model Deploy was disapproved at ${{env.timestamp}}."
          fi
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}
          SENDER: ${{ github.event.sender.login }}
          NUMBER: ${{ github.event.issue.number }}
          STATE_REASON: ${{ github.event.issue.state_reason }}
  add-tags:
    needs: add-comment
    runs-on: ubuntu-latest
    steps:
      - id: modelname
        run: |
          echo "modelname=$(echo "${{ github.event.issue.body }}" | grep -oP 'model name :\s*\K\w+')" >> $GITHUB_ENV
      - id: modelversion
        run: |
          echo "modelversion=$(cat ./versions/version)"